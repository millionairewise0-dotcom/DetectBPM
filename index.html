<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de BPM para YouTube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-tap {
            transition: all 0.1s ease-in-out;
        }
        .btn-tap:active {
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        #bpm-display {
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-700">

        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">Detector de BPM</h1>
            <p class="text-gray-400 mt-2">Cole um link do YouTube e escolha como medir o ritmo.</p>
        </div>

        <!-- Seção de Input do YouTube -->
        <div class="mb-6">
            <label for="youtube-url" class="block text-sm font-medium text-gray-300 mb-2">Link do Vídeo do YouTube</label>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="url" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200">
                <button id="embed-video-btn" class="w-full sm:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition duration-200 whitespace-nowrap">Carregar Vídeo</button>
            </div>
        </div>
        
        <!-- Player de Vídeo -->
        <div id="video-container" class="aspect-video bg-gray-900 rounded-lg border border-gray-700 flex items-center justify-center transition-all duration-300 mb-6">
             <p id="video-placeholder" class="text-gray-500">O player de vídeo aparecerá aqui.</p>
        </div>

        <!-- Seleção de Método -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">

            <!-- Detector Automático -->
            <div class="flex flex-col items-center justify-center bg-gray-900/50 p-6 rounded-lg border border-gray-700 h-full">
                <h2 class="text-xl font-semibold mb-4 text-white">Detecção Automática</h2>
                <div id="auto-bpm-result" class="h-24 flex items-center justify-center">
                    <div id="auto-bpm-display" class="text-7xl font-bold text-white hidden">0</div>
                    <div id="auto-bpm-loader" class="loader hidden"></div>
                    <p id="auto-bpm-placeholder" class="text-gray-500">Clique abaixo para analisar.</p>
                </div>
                <button id="auto-detect-btn" class="w-full mt-4 px-6 py-3 bg-teal-600 hover:bg-teal-700 rounded-lg font-semibold transition duration-200">
                    Analisar Automaticamente
                </button>
            </div>

            <!-- Detector de Toque Manual -->
            <div class="flex flex-col items-center justify-center bg-gray-900/50 p-6 rounded-lg border border-gray-700 h-full">
                 <h2 class="text-xl font-semibold mb-2 text-white">Medidor Manual</h2>
                <p class="text-gray-400 text-sm mb-2">Toque no ritmo da música</p>
                <div id="tap-bpm-display" class="text-7xl font-bold text-white">0</div>
                <p class="text-gray-500 text-xs mb-2 h-4" id="tap-bpm-stability">Aguardando...</p>
                <button id="tap-btn" class="btn-tap w-full h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg text-xl font-bold shadow-lg hover:shadow-blue-500/50">
                    TOQUE
                </button>
                 <button id="reset-btn" class="mt-3 text-gray-400 hover:text-white text-sm transition-colors">Resetar</button>
            </div>
        </div>

    </div>

    <script>
        // --- Lógica para o Player do YouTube ---
        const youtubeUrlInput = document.getElementById('youtube-url');
        const embedVideoBtn = document.getElementById('embed-video-btn');
        const videoContainer = document.getElementById('video-container');
        const videoPlaceholder = document.getElementById('video-placeholder');

        embedVideoBtn.addEventListener('click', () => {
            const url = youtubeUrlInput.value;
            if (url && (url.includes('youtube.com') || url.includes('youtu.be'))) {
                const videoId = getYouTubeVideoId(url);
                if (videoId) {
                    videoPlaceholder.style.display = 'none';
                    videoContainer.innerHTML = `
                        <iframe class="w-full h-full rounded-lg" 
                                src="https://www.youtube.com/embed/${videoId}" 
                                title="YouTube video player" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>`;
                } else {
                    alert('Não foi possível extrair o ID do vídeo. Verifique o link.');
                }
            } else {
                alert('Por favor, insira um link válido do YouTube.');
            }
        });

        function getYouTubeVideoId(url) {
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                }
            } catch (error) {
                const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                const match = url.match(regex);
                if (match) {
                    videoId = match[1];
                }
            }
            return videoId;
        }

        // --- Lógica para Detecção Automática (Conectada ao Backend) ---
        const autoDetectBtn = document.getElementById('auto-detect-btn');
        const autoBpmDisplay = document.getElementById('auto-bpm-display');
        const autoBpmLoader = document.getElementById('auto-bpm-loader');
        const autoBpmPlaceholder = document.getElementById('auto-bpm-placeholder');

        autoDetectBtn.addEventListener('click', () => {
            const url = youtubeUrlInput.value;
            if (!url) {
                alert('Por favor, insira um link do YouTube primeiro.');
                return;
            }
            fetchBpmFromBackend(url);
        });

        function fetchBpmFromBackend(url) {
            console.log('Iniciando detecção automática para:', url);
            // Mostrar estado de carregamento
            autoBpmPlaceholder.classList.add('hidden');
            autoBpmDisplay.classList.add('hidden');
            autoBpmLoader.classList.remove('hidden');

            // A URL será relativa à sua própria implantação na Vercel
            fetch('/api/detect-bpm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ youtubeUrl: url })
            })
            .then(response => {
                if (!response.ok) {
                    // Se o servidor retornar um erro, ele será capturado aqui
                    return response.json().then(err => { throw new Error(err.error || 'Erro desconhecido do servidor') });
                }
                return response.json();
            })
            .then(data => {
                // Esconder o loader e mostrar o resultado
                autoBpmLoader.classList.add('hidden');
                autoBpmDisplay.textContent = Math.round(data.bpm);
                autoBpmDisplay.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Erro ao contatar o servidor:', error);
                autoBpmLoader.classList.add('hidden');
                autoBpmPlaceholder.textContent = `Erro: ${error.message}`;
                autoBpmPlaceholder.classList.remove('hidden');
                autoBpmPlaceholder.classList.add('text-red-400');
            });
        }


        // --- Lógica para o Detector de BPM por Toque Manual ---
        const tapBtn = document.getElementById('tap-btn');
        const resetBtn = document.getElementById('reset-btn');
        const tapBpmDisplay = document.getElementById('tap-bpm-display');
        const tapBpmStability = document.getElementById('tap-bpm-stability');

        let tapTimestamps = [];
        const maxTaps = 20;
        let resetTimeout;
        const resetDelay = 2000;

        function resetBpm() {
            tapTimestamps = [];
            tapBpmDisplay.textContent = '0';
            tapBpmStability.textContent = 'Aguardando...';
            tapBpmStability.classList.remove('text-green-400', 'text-yellow-400');
            tapBpmStability.classList.add('text-gray-500');
        }

        tapBtn.addEventListener('click', () => {
            clearTimeout(resetTimeout);
            const now = Date.now();
            tapTimestamps.push(now);
            if (tapTimestamps.length > maxTaps) {
                tapTimestamps.shift();
            }
            if (tapTimestamps.length > 1) {
                calculateBpm();
            } else {
                 tapBpmStability.textContent = 'Toque mais vezes...';
            }
            resetTimeout = setTimeout(resetBpm, resetDelay);
        });
        
        resetBtn.addEventListener('click', resetBpm);

        function calculateBpm() {
            const intervals = [];
            for (let i = 1; i < tapTimestamps.length; i++) {
                intervals.push(tapTimestamps[i] - tapTimestamps[i - 1]);
            }
            const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            if (averageInterval > 0) {
                const bpm = 60000 / averageInterval;
                tapBpmDisplay.textContent = Math.round(bpm);
                updateStability(intervals);
            }
        }

        function updateStability(intervals) {
            if (intervals.length < 5) {
                tapBpmStability.textContent = 'Calculando...';
                tapBpmStability.classList.remove('text-green-400', 'text-yellow-400');
                tapBpmStability.classList.add('text-gray-500');
                return;
            }
            const mean = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const stdDev = Math.sqrt(intervals.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / intervals.length);
            const variancePercent = (stdDev / mean) * 100;

            if (variancePercent < 3) {
                tapBpmStability.textContent = 'Ritmo estável';
                tapBpmStability.classList.add('text-green-400');
                tapBpmStability.classList.remove('text-gray-500', 'text-yellow-400');
            } else if (variancePercent < 7) {
                tapBpmStability.textContent = 'Ritmo quase estável';
                tapBpmStability.classList.add('text-yellow-400');
                tapBpmStability.classList.remove('text-gray-500', 'text-green-400');
            } else {
                tapBpmStability.textContent = 'Ritmo instável';
                tapBpmStability.classList.remove('text-gray-500', 'text-green-400', 'text-yellow-400');
            }
        }
    </script>

</body>
</html>